---
title: "QuoteFinderApp stats"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  pdf_document:
    toc: false
    latex_engine: xelatex
fontsize: 12pt
classoption: a4paper
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{Carlito}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dev='cairo_pdf', fig.height = 3.8)
library("tidyverse")
library("extrafont")
loadfonts(device="pdf")
library("tinytex")
Sys.setlocale("LC_TIME", "en_US.UTF-8")
```

```{r}
logsFolder <- "/var/log/shiny-server"


logs <- list.files(path = logsFolder, pattern = "QuoteFinderApp", full.names = TRUE)

logDF <- logs %>% map(., .f = ~ read_lines(file = .x) %>% str_subset(pattern = "-Wordcloud")) %>% unlist() %>% as.data.frame() %>% separate(col = ".", into = c("Date", "Rest"), sep = " ") %>% separate(col = "Rest", into = c("Hour", "Wordcloud", "Language"), sep = "-") %>% mutate(Date = as.Date(Date)) %>%  mutate(DateTime = paste(Date, Hour, sep = "-")) %>% mutate(DateTime = lubridate::ymd_hms(DateTime)) %>% mutate(DateTime = format(DateTime, tz = "CET"))
```

The QuoteFinder app has generated `r scales::comma(nrow(logDF))` wordclouds. On average, this correponds to about `r round( nrow(logDF)/as.numeric(max(logDF$Date)-min(logDF$Date)))` wordclouds per day.

```{r}

logDF %>% 
  group_by(Date) %>% 
  count() %>% 
  ggplot(mapping = aes(x = Date, y = n)) + 
  geom_col() +
  scale_y_continuous(name = "Wordclouds generated on given day") +
  scale_x_date(name = "") +
  labs(title = "Number of wordclouds generated by the QuoteFinder app", subtitle = paste("Between ", format(min(logDF$Date), "%d %B %Y"), " and ", format(max(logDF$Date), "%d %B %Y"))) +
  theme_minimal(base_family = "Carlito") 



```

```{r}

logDF %>% 
  filter(Date > as.Date(Sys.Date())-15) %>% 
  group_by(Date) %>% 
  count() %>% 
  ggplot(mapping = aes(x = Date, y = n)) + 
  geom_col() +
  scale_y_continuous(name = "Wordclouds generated on given day") +
  scale_x_date(name = "", breaks = scales::pretty_breaks(10)) +
  labs(title = "Number of wordclouds generated by the QuoteFinder app", subtitle = paste("Between ", format(min(logDF$Date), "%d %B %Y"), " and ", format(max(logDF$Date), "%d %B %Y"))) +
  theme_minimal(base_family = "Carlito") 
```



```{r}
logDF %>% 
  mutate(Month=format(logDF$Date, "%B %Y"), MonthOrder = format(logDF$Date, "%Y%m")) %>% 
  group_by(Month, MonthOrder) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(MonthOrder) %>% 
  mutate(Month = forcats::as_factor(Month)) %>% 
  ggplot(mapping = aes(x = Month, y = n)) + 
  geom_col() +
  scale_y_continuous(name = "Wordclouds generated on given day") +
  scale_x_discrete(name = "") +
  labs(title = "Number of wordclouds generated by the QuoteFinder app", subtitle = paste("Between ", format(min(logDF$Date), "%d %B %Y"), " and ", format(max(logDF$Date), "%d %B %Y"))) +
  theme_minimal(base_family = "Carlito") 
```


As expected, the QuoteFinder app has mostly been used during working hours. Data, however, point at meaningful usage also in the evenings until 1am. 

```{r}
logDF %>% mutate(Hour = lubridate::hour(DateTime)) %>% group_by(Hour) %>% 
  count() %>% 
  ggplot(mapping = aes(x = Hour, y = n)) +
  scale_y_continuous() +
  scale_x_continuous(breaks = scales::pretty_breaks(8)) +
  geom_col() +
  labs(title = "Number of wordclouds created by time of the day", subtitle = paste("Between ", format(min(logDF$Date), "%d %B %Y"), " and ", format(max(logDF$Date), "%d %B %Y"))) +
  theme_minimal(base_family = "Carlito") 
  
  
```


English has been by far the most used language by users of the QuoteFinder app. 

```{r}

logDF %>%
    select(Language) %>%
    mutate(Language = as.character(fct_lump(f = Language, n = 5))) %>% 
    group_by(Language) %>% 
    count(sort = TRUE) %>% 
    ungroup() %>% 
    mutate(Language = factor(Language, levels=c(unique(Language)[unique(Language)!="Other"], 'Other'))) %>% 
    mutate(n = n) %>% 
    arrange(Language) %>% 
  ggplot(mapping = aes(x = Language, y = n)) +
           geom_col() + 
  scale_y_continuous(name = "# of wordclouds") +
  scale_x_discrete("") +
  labs(title = "Number of wordclouds per language") +
    theme_minimal(base_family = "Carlito") 
 
```

